const fs = require('fs');
const path = require('path');
const { sendMessage } = require('./sendMessage');

const commands = new Map();
const prefix = '-';

// Load command modules
fs.readdirSync(path.join(__dirname, '../commands'))
  .filter(file => file.endsWith('.js'))
  .forEach(file => {
    const command = require(`../commands/${file}`);
    commands.set(command.name.toLowerCase(), command);
  });

async function handleMessage(event, pageAccessToken) {
  const senderId = event?.sender?.id;
  if (!senderId) return console.error('Invalid event object');

  const messageText = event?.message?.text?.trim();
  if (!messageText) return console.log('Received event without message text');

  const [commandName, ...args] = messageText.startsWith(prefix)
    ? messageText.slice(prefix.length).split(' ')
    : messageText.split(' ');



  
  try {
    if (commands.has(commandName.toLowerCase())) {
      await commands.get(commandName.toLowerCase()).execute(senderId, args, pageAccessToken, sendMessage);
    } else if {
      //Handling remini command
      if (messageText === 'remini') {
  const lastImage = lastImageByUser.get(senderId);
  if (lastImage) {
    try {
      await commands.get('remini').execute(senderId, [], pageAccessToken, lastImage);
      lastImageByUser.delete(senderId); // Remove the image from memory after processing
    } catch (error) {
      await sendMessage(senderId, { text: 'âŒ ğ—”ğ—» ğ—²ğ—¿ğ—¿ğ—¼ğ—¿ ğ—¼ğ—°ğ—°ğ˜‚ğ—¿ğ—¿ğ—²ğ—± ğ˜„ğ—µğ—¶ğ—¹ğ—² ğ—½ğ—¿ğ—¼ğ—°ğ—²ğ˜€ğ˜€ğ—¶ğ—»ğ—´ ğ˜ğ—µğ—² ğ—¶ğ—ºğ—®ğ—´ğ—².' }, pageAccessToken);
    }
  } else {
    await sendMessage(senderId, { text: 'âŒ ğ—£ğ—¹ğ—²ğ—®ğ˜€ğ—² ğ˜€ğ—²ğ—»ğ—± ğ—®ğ—» ğ—¶ğ—ºğ—®ğ—´ğ—² ğ—³ğ—¶ğ—¿ğ˜€ğ˜, ğ˜ğ—µğ—²ğ—» ğ˜ğ˜†ğ—½ğ—² "ğ—¿ğ—²ğ—ºğ—¶ğ—»ğ—¶" ğ˜ğ—¼ ğ—²ğ—»ğ—µğ—®ğ—»ğ—°ğ—² ğ—¶ğ˜.' }, pageAccessToken);
  }
  return;
}
    } else {
      await commands.get('gpt4').execute(senderId, [messageText], pageAccessToken);
    }

    
  } catch (error) {
    console.error(`Error executing command:`, error);
    await sendMessage(senderId, { text: error.message || 'There was an error executing that command.' }, pageAccessToken);
  }
}

module.exports = { handleMessage };
